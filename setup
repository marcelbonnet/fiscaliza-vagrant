#!/bin/bash
# 2020-05-27

echo -n "Atualizando utilitários..."
curl -s -O -L https://github.com/marcelbonnet/fiscaliza-vagrant/archive/master.zip
rm -rf fiscaliza-vagrant-master
unzip master.zip && rm master.zip
[[ $? -ne 0 ]] && echo "Houve erro. Tente mais tarde." && exit
[[ -e /root/bin ]] || mkdir /root/bin
[[ ! -e bin/ajuda ]] && ln -s /root/fiscaliza-vagrant-master/ajuda bin/ajuda
cp /root/fiscaliza-vagrant-master/motd /etc/motd


# #############################################################################
#  PATCH REDMINE DE SUPORTE
# #############################################################################
if [ ! -e /root/.patch_suporte_ok ]; then 
cat <<EOF > /etc/httpd/conf.d/redmine323
# Este arquivo deve ser importado por 0.conf
     Alias "/fiscaliza323" "/opt/redmine323fiscaliza/public"
     <LocationMatch "^/fiscaliza323/(?!suporte).*">
          PassengerRuby /usr/local/rvm/wrappers/ruby-2.2.2/ruby
          PassengerBaseURI /fiscaliza323
          PassengerAppRoot /opt/redmine323fiscaliza
          PassengerUser apache
          RailsEnv development
     </LocationMatch>
     <Directory "/opt/redmine323fiscaliza/public">
         Allow from all
         Options -MultiViews
         Require all granted
     </Directory>

      Alias "/fiscaliza323/suporte" "/opt/redmine323suporte/public"
      <LocationMatch "^/fiscaliza323/suporte">
          PassengerRuby /usr/local/rvm/wrappers/ruby-2.2.2/ruby
          PassengerBaseURI /fiscaliza323/suporte
          PassengerAppRoot /opt/redmine323suporte
          PassengerUser apache
          RailsEnv development
     </LocationMatch>
     <Directory "/opt/redmine323suporte/public">
         Allow from all
         Options -MultiViews
         Require all granted
     </Directory>
EOF
cp /opt/redmine323fiscaliza/Gemfile /opt/redmine323suporte/Gemfile
> /root/.patch_suporte_ok
fi

if [ ! -e /root/.patch_suporte_db_ok ]; then 
	sed -e "s,database:.*,#database: nome_da_base," /opt/redmine323fiscaliza/config/database.yml > /opt/redmine323suporte/config/database.yml
	> /root/.patch_suporte_db_ok
	echo "-- Aplicado patch do Suporte (database). Configure sua base de dados agora."
fi

if [ ! -e /root/.patch_suporte_db2_ok ]; then 
	echo "  database: redmine323suporte" >> /opt/redmine323suporte/config/database.yml
	> /root/.patch_suporte_db2_ok
	cp -v /opt/redmine323fiscaliza/config/additional_environment.rb /opt/redmine323suporte/config/additional_environment.rb
	echo "-- Aplicado patch #2 do Suporte. Adicionei o database padrão. "
	echo "-- Configurei os logs do ambiente de suporte."
fi


# ############ Phusion Passenger, não temos o pacote de suporte nativo
if [ ! -e /root/.patch_passenger_native_support_ok ]; then 
  local f=/etc/httpd/conf.d/redmine323
  sed -i '9i    SetEnv PASSENGER_DOWNLOAD_NATIVE_SUPPORT_BINARY 0' $f && sed -i '23i    SetEnv PASSENGER_DOWNLOAD_NATIVE_SUPPORT_BINARY 0' $f
  > /root/.patch_passenger_native_support_ok
  echo "-- Aplicado em config do Redmine no Apache (${f})."
  echo "-- Reiniciar as instâncias do Redmine deve ficar bem mais rápido."
fi

# esses arquivos não devem ser removidos sobre pena de rodar a atualização novamente, sobrescrevendo modificações do usuário da VM
chattr +i /root/.patch_*
